<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™‚å…‰æ©Ÿ V30.0 (Ultimate Edition)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --highlight: #00cec9; 
            --visual: #e17055;    
            --vocal: #fd79a8;     
            --mandarin: #e84393;  
            --japan: #6c5ce7;     
            --english: #0984e3;   
            --param: #74b9ff;     
            --lyric: #fab1a0;     
            --text: #dfe6e9;
            --border: #333;
            --block-bg: #2d3436;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text); 
            padding: 20px; 
            max-width: 900px; 
            margin: 0 auto; 
            padding-bottom: 450px; 
        }

        h2 { 
            text-align: center; 
            color: var(--highlight); 
            font-weight: 300; 
            letter-spacing: 2px;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        /* å€å¡Šé€šç”¨ */
        .section-box {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s;
        }

        .section-box.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(0.8); }
        .section-title { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .grid-mini { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        .choice-btn {
            background: #2d2d2d; border: 1px solid var(--border); color: var(--text); padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px;
        }
        .choice-btn:hover { background: #3d3d3d; }
        .choice-btn.active { border-color: var(--highlight); background: rgba(0, 206, 201, 0.1); color: var(--highlight); font-weight: bold; }

        .btn-lang.active[data-lang="cn"] { background: rgba(232, 67, 147, 0.2); border-color: var(--mandarin); color: var(--mandarin); }
        .btn-lang.active[data-lang="jp"] { background: rgba(108, 92, 231, 0.2); border-color: var(--japan); color: var(--japan); }
        .btn-lang.active[data-lang="en"] { background: rgba(9, 132, 227, 0.2); border-color: var(--english); color: var(--english); }
        .btn-sub { font-size: 10px; opacity: 0.6; margin-top: 4px; font-weight: normal; }

        /* çµæ§‹èˆ‡åŠ›åº¦ (å›æ­¸ V27.1 ä¸‹æ‹‰é¸å–®æ¨£å¼) */
        .structure-rows { display: flex; flex-direction: column; gap: 8px; }
        .struct-row { display: flex; align-items: center; background: var(--block-bg); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; gap: 10px; }
        .struct-row.inactive { opacity: 0.5; background: transparent; border-style: dashed; }
        .struct-check { display: flex; align-items: center; cursor: pointer; min-width: 80px; font-weight: bold; font-size: 12px; color: var(--highlight); }
        .checkbox-fake { width: 14px; height: 14px; border: 1px solid #777; border-radius: 3px; margin-right: 8px; display: inline-block; position: relative; }
        .struct-row.active .checkbox-fake { background: var(--highlight); border-color: var(--highlight); }
        .struct-select { flex: 1; background: #111; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 6px; font-size: 11px; outline: none; cursor: pointer; }
        
        .struct-row.inactive .struct-select { pointer-events: none; color: #555; border-color: #333; }

        .theme-input { width: 100%; background: #000; border: 1px solid var(--lyric); color: #fff; padding: 12px; border-radius: 6px; font-size: 14px; box-sizing: border-box; outline: none; }

        /* è¼¸å‡ºé¢æ¿ (V29 ç¨ç«‹è¤‡è£½ç‰ˆ) */
        .output-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #111; border-top: 3px solid var(--highlight); padding: 15px; box-shadow: 0 -10px 40px rgba(0,0,0,0.9); z-index: 100; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px;
        }

        .output-group { flex: 1; display: flex; flex-direction: column; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .output-label { font-size: 11px; color: #777; font-weight: bold; text-transform: uppercase; }
        
        .btn-mini-copy {
            background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; padding: 3px 10px; font-size: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .btn-mini-copy:hover { background: #555; }
        
        textarea {
            width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px; font-family: monospace; resize: none; box-sizing: border-box; font-size: 11px;
        }
        
        #style-box { height: 45px; color: var(--highlight); }
        #lyrics-box { height: 70px; color: #a29bfe; border-color: #a29bfe; }
        #params-box { height: 35px; color: var(--param); border-color: var(--param); }

        .action-row { display: flex; gap: 10px; margin-top: 5px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-prompt { background: var(--lyric); color: #000; flex: 2; }
        .btn-reset { background: #222; color: #777; flex: 0.5; border: 1px solid #444; }
        .btn-reset:hover { background: #333; color: #fff; }

    </style>
</head>
<body>

    <h2>æ™‚å…‰æ©Ÿ <span style="font-size:0.5em; opacity:0.5;">V30.0</span></h2>

    <div class="section-box">
        <div class="section-title"><span>1. èªè¨€ (Language)</span></div>
        <div class="grid-container" style="grid-template-columns: repeat(3, 1fr);">
            <button class="choice-btn btn-lang" data-lang="cn" onclick="selectLang('cn', this)"><span>ğŸ‡¨ğŸ‡³ è¯èª/ç²µèª</span></button>
            <button class="choice-btn btn-lang" data-lang="jp" onclick="selectLang('jp', this)"><span>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span></button>
            <button class="choice-btn btn-lang" data-lang="en" onclick="selectLang('en', this)"><span>ğŸ‡ºğŸ‡¸ English</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-era">
        <div class="section-title"><span>2. å¹´ä»£ (Time Travel)</span> <span id="label-era" style="color:var(--highlight)"></span></div>
        <div class="grid-container" style="grid-template-columns: repeat(4, 1fr);">
            <button class="choice-btn" onclick="selectEra('70s', this)"><span>70s</span><span class="btn-sub">Vintage</span></button>
            <button class="choice-btn" onclick="selectEra('80s', this)"><span>80s</span><span class="btn-sub">Retro</span></button>
            <button class="choice-btn" onclick="selectEra('90s', this)"><span>90s</span><span class="btn-sub">Classic</span></button>
            <button class="choice-btn" onclick="selectEra('00s', this)"><span>00s</span><span class="btn-sub">Millennium</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-vocal" style="border-left: 3px solid var(--vocal);">
        <div class="section-title"><span>3. éˆé­‚é¸è§’ (Vocal)</span></div>
        <div class="grid-mini">
            <button class="choice-btn" onclick="selectGender('male', this)"><span>ğŸ™‹ğŸ»â€â™‚ï¸ ç”·è² (Male)</span><span class="btn-sub" id="desc-male">--</span></button>
            <button class="choice-btn" onclick="selectGender('female', this)"><span>ğŸ™‹ğŸ»â€â™€ï¸ å¥³è² (Female)</span><span class="btn-sub" id="desc-female">--</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-struct">
        <div class="section-title"><span>4. å°æ¼”çµæ§‹ (Intensity Control)</span> <span style="font-size:10px; color:#777">å‹¾é¸å•Ÿç”¨ â€¢ ä¸‹æ‹‰é¸æ“‡åŠ›åº¦</span></div>
        <div class="structure-rows" id="struct-container"></div>
    </div>

    <div class="section-box disabled" id="section-theme" style="border-left: 3px solid var(--lyric);">
        <div class="section-title"><span style="color:var(--lyric)">5. æ­Œè©ä¸»é¡Œ (çµ¦ AI å¡«è©ç”¨)</span></div>
        <input type="text" id="theme-input" class="theme-input" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ä¸‹é›¨çš„å¤œæ™šï¼Œæ€å¿µå‰ä»»...">
    </div>

    <div class="output-panel">
        
        <div class="output-group">
            <div class="output-header">
                <span class="output-label">Style (é¢¨æ ¼) <span id="logic-log" style="font-weight:normal; text-transform:none; margin-left:5px; color:#555;"></span></span>
                <button class="btn-mini-copy" onclick="copySingle('style-box', this)">ğŸ“‹ è¤‡è£½ Style</button>
            </div>
            <textarea id="style-box" readonly placeholder="Style Tags..."></textarea>
        </div>

        <div class="output-group">
            <div class="output-header">
                <span class="output-label" style="color: var(--param)">Params (åƒæ•¸)</span>
                <button class="btn-mini-copy" onclick="copySingle('params-box', this)">ğŸ“‹ è¤‡è£½ Params</button>
            </div>
            <textarea id="params-box" readonly placeholder="Weirdness / Exclude..."></textarea>
        </div>

        <div class="output-group">
            <div class="output-header">
                <span class="output-label">Lyrics (çµæ§‹/æ­Œè©)</span>
                <button class="btn-mini-copy" onclick="copySingle('lyrics-box', this)">ğŸ“‹ è¤‡è£½ Lyrics</button>
            </div>
            <textarea id="lyrics-box" readonly placeholder="Structure..."></textarea>
        </div>

        <div class="action-row">
            <button class="action-btn btn-prompt" onclick="copyLyricsPrompt()">ğŸ¤– è¤‡è£½å¡«è© Prompt (çµ¦ ChatGPT)</button>
            <button class="action-btn btn-reset" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <script>
        // --- V27.1 çš„è©³ç´°è³‡æ–™åº« (å«åŠ›åº¦ä¸‹æ‹‰é¸å–®) ---
        const timeMachineData = {
            "cn": {
                "70s": {
                    baseTags: "70s Mandopop, Vintage Recording, Analog Warmth, Mono, Low Fidelity, Tape Hiss, Slow Tempo",
                    params: "Exclude: Modern, Digital | Weirdness: 20% | Influence: 85%",
                    vocals: { male: { tag: "Warm, Conversational, Folk Style", desc: "è¨±å† å‚‘å¼" }, female: { tag: "Sweet, Airy, Whispery, Crystal Clear", desc: "é„§éº—å›å¼" } },
                    structureOptions: {
                        intro: [
                            { label: "æ¥µç°¡ç¨å¥ (é•·ç¬›/å‰ä»–)", val: "[Intro: Melodic Flute Solo, Minimalist]" },
                            { label: "ç®¡å¼¦æ¨‚åœ˜ (å¤§æ°£)", val: "[Intro: Orchestral Strings Intro]" }
                        ],
                        verse: [ { label: "æ•˜äº‹æ„Ÿ (è²¼è€³)", val: "[Verse 1: Sweet Airy Vocals, Very Close Proximity]" } ],
                        chorus: [ { label: "æº«æŸ”å’Œè² (æŠ’æƒ…)", val: "[Chorus: Gentle Harmony, Sentimental]" } ],
                        bridge: [
                            { label: "å‰ä»–ç¨å¥ (ç¶“å…¸)", val: "[Bridge: Acoustic Guitar Solo]" },
                            { label: "ç„¡ (ç›´æ¥é€²çµå°¾)", val: "" }
                        ],
                        outro: [
                            { label: "æ·¡å‡º (Fade Out)", val: "[Outro: Fade out]" },
                            { label: "å£ç™½ (Spoken)", val: "[Outro: Spoken Word, Whisper]" }
                        ]
                    }
                },
                "80s": {
                    baseTags: "80s Cantopop, Synth-Pop, Gated Reverb, Analog Synth, Dramatic",
                    params: "Exclude: Acoustic | Weirdness: 30% | Influence: 70%",
                    vocals: { male: { tag: "Romantic, Baritone, Heavy Reverb", desc: "å¼µåœ‹æ¦®å¼" }, female: { tag: "Contralto, Soulful, Powerful", desc: "æ¢…è‰·èŠ³å¼" } },
                    structureOptions: {
                        intro: [
                            { label: "Synth+é‡é¼“ (å‹•æ„Ÿ)", val: "[Intro: Synth Hook and Heavy Gated Reverb Drums]" },
                            { label: "è–©å…‹æ–¯é¢¨ (æµªæ¼«)", val: "[Intro: Saxophone Solo, City Night Vibe]" }
                        ],
                        verse: [ { label: "æ·±æƒ… (Reverb)", val: "[Verse 1: Reverb Heavy Vocals]" } ],
                        chorus: [ { label: "æœ—æœ—ä¸Šå£ (Catchy)", val: "[Chorus: Catchy Melody, Romantic]" } ],
                        bridge: [
                            { label: "é›»å‰ä»–ç¨å¥ (è¯éº—)", val: "[Bridge: Electric Guitar Solo, Gated Reverb]" },
                            { label: "é¼“è²éé–€ (Fill)", val: "[Bridge: Drum Solo Fill]" }
                        ],
                        outro: [ { label: "é‡è¤‡ä¸¦æ·¡å‡º", val: "[Outro: Repeat Chorus and Fade out]" } ]
                    }
                },
                "90s": {
                    baseTags: "90s Mandopop, Power Ballad, Orchestral, Piano, Wide Stereo",
                    params: "Exclude: Lofi | Weirdness: 40%",
                    vocals: { male: { tag: "Deep, Heavy Vibrato, Belting", desc: "å¼µå­¸å‹å¼" }, female: { tag: "Ethereal, Falsetto, Dream Pop", desc: "ç‹è²å¼" } },
                    structureOptions: {
                        intro: [
                            { label: "é‹¼ç´ç¨å¥ (ç¶“å…¸)", val: "[Intro: Grand Piano Solo]" },
                            { label: "å¼¦æ¨‚äº¤éŸ¿ (å¤§æ­Œ)", val: "[Intro: Full Orchestral Strings]" }
                        ],
                        verse: [ { label: "ä½æ²ˆé‹ªé™³", val: "[Verse 1: Deep Emotional Vocals]" } ],
                        chorus: [
                            { label: "çˆ†ç™¼åŠ› (Power)", val: "[Chorus: Powerful Belting, Full Orchestra, Wall of Sound]" },
                            { label: "é¡«éŸ³æŠ’æƒ… (Vibrato)", val: "[Chorus: Emotional with Heavy Vibrato]" }
                        ],
                        bridge: [
                            { label: "æ¼¸å¼±ç…è»Š (Decrescendo)", val: "[Bridge: Decrescendo, Slowing Down, Strip back instruments]" }, 
                            { label: "æƒ…ç·’å †ç–Š (Build-up)", val: "[Bridge: Rising Tension, Drum Roll]" }
                        ],
                        outro: [
                            { label: "é©Ÿåœ (Silence)", val: "[Outro: Sudden Silence, Piano decay]" },
                            { label: "æ‹–é•·éŸ³", val: "[Outro: Long high note]" }
                        ]
                    }
                },
                "00s": {
                    baseTags: "00s Mandopop, R&B, Pentatonic, Hip Hop Beat",
                    params: "Exclude: EDM | Weirdness: 40%",
                    vocals: { male: { tag: "Mumble, R&B Flow, Slurred", desc: "å‘¨æ°å€«å¼" }, female: { tag: "Youthful, Bright, Pop", desc: "æ¢éœèŒ¹å¼" } },
                    structureOptions: {
                        intro: [
                            { label: "å¤å…¸é‹¼ç´", val: "[Intro: Classical Piano Solo]" },
                            { label: "ç‰¹æ•ˆ/éˆ´è²", val: "[Intro: Sound FX, Vinyl scratch]" }
                        ],
                        verse: [ { label: "é¥’èˆŒå”¸ç™½ (Rap)", val: "[Verse 1: Mumble Rap style, Laid back]" } ],
                        chorus: [ { label: "ä¸­åœ‹é¢¨ R&B", val: "[Chorus: R&B Melody with Chinese Instruments]" } ],
                        bridge: [
                            { label: "å¿«å˜´ Rap", val: "[Bridge: Fast Rap Flow]" },
                            { label: "åŠé€Ÿ (Half-time)", val: "[Bridge: Half-time Breakdown]" }
                        ],
                        outro: [ { label: "é‹¼ç´æ”¶å°¾", val: "[Outro: Soft Piano]" } ]
                    }
                }
            },
            "jp": {
                "70s": {
                    baseTags: "70s Enka, Kayokyoku, Showa Era, Orchestral, Melodramatic",
                    params: "Exclude: Modern | Weirdness: 30%",
                    vocals: { male: {tag: "Deep, Kobushi", desc: "æ¼”æ­Œ"}, female: {tag: "Melancholic", desc: "æ˜­å’Œ"} },
                    structureOptions: {
                        intro: [{label:"å£ç™½ (Spoken)", val:"[Intro: Spoken Word with Emotion]"}, {label:"æ¼”æ­Œå‰å¥", val:"[Intro: Traditional Enka Intro]"}],
                        verse: [{label:"å“€æ„", val:"[Verse 1: Melancholic Vocals]"}],
                        chorus: [{label:"æ‚²å£¯ (Dramatic)", val:"[Chorus: Powerful, Dramatic, Kobushi]"}],
                        bridge: [{label:"è–©å…‹æ–¯é¢¨ç¨å¥", val:"[Bridge: Saxophone Solo]"}],
                        outro: [{label:"è¯éº—çµå°¾", val:"[Outro: Grand Finale]"}]
                    }
                },
                "80s": {
                    baseTags: "City Pop, Funk, Slap Bass, Neon, Urban",
                    params: "Exclude: Sad | Weirdness: 60%",
                    vocals: { male: {tag: "Funky", desc: "é”éƒå¼"}, female: {tag: "Bright, Idol", desc: "è–å­å¼"} },
                    structureOptions: {
                        intro: [{label:"Funky Guitar", val:"[Intro: Funky Guitar and Slap Bass]"}],
                        verse: [{label:"Smooth", val:"[Verse 1: Smooth Vocals]"}],
                        chorus: [{label:"è¼•å¿« (Upbeat)", val:"[Chorus: Catchy Melody, Upbeat]"}],
                        bridge: [{label:"Synth Solo", val:"[Bridge: Synthesizer Solo]"}],
                        outro: [{label:"Fade Out", val:"[Outro: Fade out]"}]
                    }
                },
                "90s": {
                    baseTags: "J-Rock, Visual Kei, Distortion, Fast Tempo",
                    params: "Exclude: Pop | Weirdness: 50%",
                    vocals: { male: {tag: "Nasal, High Pitch", desc: "è¦–è¦ºç³»"}, female: {tag: "Power, Eurobeat", desc: "å®‰å®¤å¼"} },
                    structureOptions: {
                        intro: [{label:"Guitar Riff", val:"[Intro: Fast Guitar Riff]"}],
                        verse: [{label:"Build up", val:"[Verse 1: Low Voice building up]"}],
                        chorus: [{label:"Screaming", val:"[Chorus: High Pitch Screaming]"}],
                        bridge: [{label:"Twin Guitar", val:"[Bridge: Twin Guitar Solo]"}],
                        outro: [{label:"Feedback", val:"[Outro: Feedback Noise]"}]
                    }
                },
                "00s": {
                    baseTags: "00s J-Pop, R&B, Automatic, Polished",
                    params: "Exclude: Enka | Weirdness: 40%",
                    vocals: { male: {tag: "Smooth, R&B", desc: "å¹³äº•å …å¼"}, female: {tag: "Husky, Vibrato", desc: "å®‡å¤šç”°å¼"} },
                    structureOptions: {
                        intro: [{label:"Electronic", val:"[Intro: Electronic Beat]"}],
                        verse: [{label:"R&B Flow", val:"[Verse 1: R&B Flow]"}],
                        chorus: [{label:"Emotional", val:"[Chorus: Emotional Melody]"}],
                        bridge: [{label:"English Rap", val:"[Bridge: English Rap]"}],
                        outro: [{label:"Fade out", val:"[Outro: Fade out]"}]
                    }
                }
            },
            "en": {
                "70s": {
                    baseTags: "70s Soft Rock, Folk, Acoustic, Warm",
                    params: "Exclude: Digital",
                    vocals: { male: {tag: "Soft, Folk", desc: "Folk"}, female: {tag: "Warm, Velvet", desc: "Karen"} },
                    structureOptions: {
                        intro: [{label:"å‰ä»–æŒ‡å½ˆ", val:"[Intro: Acoustic Guitar Fingerpicking]"}],
                        verse: [{label:"èªªæ•…äº‹", val:"[Verse 1: Storytelling Vocals]"}],
                        chorus: [{label:"æº«æš–å’Œè²", val:"[Chorus: Warm Harmony]"}],
                        bridge: [{label:"é‹¼ç´éé–€", val:"[Bridge: Piano Interlude]"}],
                        outro: [{label:"Fade Out", val:"[Outro: Fade out]"}]
                    }
                },
                "80s": {
                    baseTags: "80s Pop, Synthwave, Analog Synth",
                    params: "Exclude: Acoustic",
                    vocals: { male: {tag: "Falsetto", desc: "MJ Style"}, female: {tag: "Power Diva", desc: "Madonna"} },
                    structureOptions: {
                        intro: [{label:"Synth Riff", val:"[Intro: Iconic Synth Riff]"}],
                        verse: [{label:"Percussive", val:"[Verse 1: Percussive Vocals]"}],
                        chorus: [{label:"High Energy", val:"[Chorus: High Energy]"}],
                        bridge: [{label:"Key Change", val:"[Bridge: Key Change]"}],
                        outro: [{label:"Ad-libs", val:"[Outro: Vocal Ad-libs]"}]
                    }
                },
                "90s": {
                    baseTags: "Britpop, Grunge, Distortion",
                    params: "Exclude: Pop",
                    vocals: { male: {tag: "Raspy, Nasal", desc: "Oasis"}, female: {tag: "Powerhouse", desc: "Mariah"} },
                    structureOptions: {
                        intro: [{label:"ç ´éŸ³å‰ä»–", val:"[Intro: Distorted Guitar Riff]"}],
                        verse: [{label:"æ…µæ‡¶ (Lazy)", val:"[Verse 1: Mumbled/Low Vocals]"}],
                        chorus: [{label:"å¤§åˆå”± (Anthem)", val:"[Chorus: Loud, Anthem-like, Distortion]"}],
                        bridge: [{label:"å™ªéŸ³å †ç–Š", val:"[Bridge: Noise Build-up]"}, {label:"ç…è»Š (Quiet)", val:"[Bridge: Sudden Quiet Section]"}],
                        outro: [{label:"Feedback Noise", val:"[Outro: Feedback and Noise]"}]
                    }
                },
                "00s": {
                    baseTags: "Pop Punk, High Energy",
                    params: "Exclude: Slow",
                    vocals: { male: {tag: "Nasal, Punk", desc: "Punk"}, female: {tag: "Sassy", desc: "Avril"} },
                    structureOptions: {
                        intro: [{label:"Drum Fill", val:"[Intro: Fast Drum Fill]"}],
                        verse: [{label:"Palm Mute", val:"[Verse 1: Palm Mute Guitar]"}],
                        chorus: [{label:"Catchy", val:"[Chorus: Catchy]"}],
                        bridge: [{label:"Half-time", val:"[Bridge: Half-time breakdown]"}],
                        outro: [{label:"Final Chord", val:"[Outro: Final Chord]"}]
                    }
                }
            }
        };

        let currentLang = null, currentEra = null, currentGender = null;

        function selectLang(lang, btn) {
            currentLang = lang; currentEra = null; currentGender = null;
            document.querySelectorAll('.btn-lang').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('section-era').classList.remove('disabled');
            document.getElementById('label-era').innerText = "è«‹é¸æ“‡å¹´ä»£...";
            document.querySelectorAll('#section-era .choice-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('section-vocal').classList.add('disabled');
            document.getElementById('section-struct').classList.add('disabled');
            document.getElementById('section-theme').classList.add('disabled');
            resetOutput();
        }

        function selectEra(era, btn) {
            currentEra = era; currentGender = null;
            document.querySelectorAll('#section-era .choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const data = timeMachineData[currentLang][era];
            document.getElementById('label-era').innerText = era;
            document.getElementById('section-vocal').classList.remove('disabled');
            document.querySelectorAll('#section-vocal .choice-btn').forEach(b => b.classList.remove('active'));
            if(data.vocals) {
                document.getElementById('desc-male').innerText = data.vocals.male.desc;
                document.getElementById('desc-female').innerText = data.vocals.female.desc;
            }
            loadStructure(data.structureOptions);
            renderOutput();
        }

        function selectGender(gender, btn) {
            currentGender = gender;
            document.querySelectorAll('#section-vocal .choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderOutput();
        }

        // --- æ ¸å¿ƒï¼šV27.1 ä¸‹æ‹‰é¸å–®çµæ§‹ç”Ÿæˆå™¨ ---
        function loadStructure(options) {
            const container = document.getElementById('struct-container');
            container.innerHTML = '';
            document.getElementById('section-struct').classList.remove('disabled');
            document.getElementById('section-theme').classList.remove('disabled');

            // é †åºï¼šIntro -> Verse -> Chorus -> Bridge -> Outro
            const order = ['intro', 'verse', 'chorus', 'bridge', 'outro'];

            order.forEach(part => {
                if (!options[part]) return;

                const row = document.createElement('div');
                row.className = 'struct-row active'; // é è¨­å•Ÿç”¨
                
                // å·¦å´å‹¾é¸
                const checkDiv = document.createElement('div');
                checkDiv.className = 'struct-check';
                checkDiv.innerHTML = `<span class="checkbox-fake"></span> ${part.charAt(0).toUpperCase() + part.slice(1)}`;
                checkDiv.onclick = () => {
                    row.classList.toggle('active');
                    row.classList.toggle('inactive');
                    renderLyrics();
                };

                // å³å´ä¸‹æ‹‰é¸å–®
                const select = document.createElement('select');
                select.className = 'struct-select';
                select.onchange = () => renderLyrics();

                options[part].forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.val;
                    option.innerText = opt.label;
                    select.appendChild(option);
                });

                row.appendChild(checkDiv);
                row.appendChild(select);
                container.appendChild(row);
            });
            renderLyrics();
        }

        function renderLyrics() {
            const rows = document.querySelectorAll('.struct-row');
            let text = "";
            rows.forEach(row => {
                if (row.classList.contains('active')) {
                    const select = row.querySelector('select');
                    if (select.value) text += select.value + "\n\n";
                }
            });
            document.getElementById('lyrics-box').value = text.trim();
        }

        function renderOutput() {
            if (!currentLang || !currentEra) return;
            const data = timeMachineData[currentLang][currentEra];
            document.getElementById('params-box').value = data.params;
            let tags = [data.baseTags];
            let logicMsg = "";
            if (currentGender && data.vocals) {
                tags.push(data.vocals[currentGender].tag);
                tags.push(currentGender === 'male' ? "Male Vocals" : "Female Vocals");
                logicMsg = `âœ¨ ${data.vocals[currentGender].desc}`;
            }
            document.getElementById('style-box').value = tags.join(", ");
            document.getElementById('logic-log').innerText = logicMsg;
        }

        // --- V29 ç¨ç«‹è¤‡è£½åŠŸèƒ½ ---
        function copySingle(elementId, btn) {
            const el = document.getElementById(elementId);
            if (!el || !el.value) return;

            navigator.clipboard.writeText(el.value).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "âœ… å·²è¤‡è£½";
                btn.style.background = "var(--highlight)";
                btn.style.color = "#000";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "#333";
                    btn.style.color = "#fff";
                }, 1500);
            });
        }

        function copyLyricsPrompt() {
            const theme = document.getElementById('theme-input').value || "é—œæ–¼æ„›æƒ…èˆ‡å›æ†¶";
            const structure = document.getElementById('lyrics-box').value;
            const era = currentEra;
            
            let langPrompt = "";
            if (currentLang === 'cn') langPrompt = "Traditional Chinese (Cantonese or Mandarin depending on context)";
            if (currentLang === 'jp') langPrompt = "Japanese (include Romaji)";
            if (currentLang === 'en') langPrompt = "English";

            const prompt = `
Role: Professional Songwriter
Task: Write lyrics for a song.

Context:
- Language: ${langPrompt}
- Era/Style: ${era} Music Style
- Theme: "${theme}"

IMPORTANT:
1. Strictly follow the structure below. Do NOT change the tags (e.g., [Intro]).
2. Match the lyrics to the "Vocal Style" described in the tags.

Structure to Fill:
${structure}
            `;
            
            navigator.clipboard.writeText(prompt);
            const btn = document.querySelector('.btn-prompt');
            btn.innerText = "âœ… Prompt å·²è¤‡è£½ï¼";
            setTimeout(() => btn.innerText = "ğŸ¤– è¤‡è£½å¡«è© Prompt (çµ¦ ChatGPT)", 2000);
        }

        function resetAll() {
            currentLang = null; currentEra = null; currentGender = null;
            document.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
            document.getElementById('section-era').classList.add('disabled');
            document.getElementById('section-vocal').classList.add('disabled');
            document.getElementById('section-struct').classList.add('disabled');
            document.getElementById('section-theme').classList.add('disabled');
            document.getElementById('style-box').value = "";
            document.getElementById('params-box').value = "";
            document.getElementById('lyrics-box').value = "";
            document.getElementById('struct-container').innerHTML = "";
            document.getElementById('label-era').innerText = "";
            document.getElementById('desc-male').innerText = "--";
            document.getElementById('desc-female').innerText = "--";
            document.getElementById('theme-input').value = "";
            document.getElementById('logic-log').innerText = "";
        }
    </script>
</body>
</html>