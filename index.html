<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI æ™‚å…‰æ©Ÿ V30.0 (One-Click Tension)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --highlight: #00cec9; 
            --visual: #e17055;    
            --vocal: #fd79a8;     
            --mandarin: #e84393;  
            --japan: #6c5ce7;     
            --english: #0984e3;   
            --param: #74b9ff;     
            --lyric: #fab1a0;     
            --tension: #ff7675;   /* å¼µåŠ›ç´… */
            --text: #dfe6e9;
            --border: #333;
            --block-bg: #2d3436;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text); 
            padding: 20px; 
            max-width: 900px; 
            margin: 0 auto; 
            padding-bottom: 450px; 
        }

        h2 { 
            text-align: center; 
            color: var(--highlight); 
            font-weight: 300; 
            letter-spacing: 2px;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        /* å€å¡Šé€šç”¨ */
        .section-box {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            position: relative;
            transition: all 0.3s;
        }

        .section-box.disabled { opacity: 0.3; pointer-events: none; filter: grayscale(0.8); }
        .section-title { font-size: 13px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }

        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .grid-mini { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

        .choice-btn {
            background: #2d2d2d; border: 1px solid var(--border); color: var(--text); padding: 10px 5px; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: center; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 50px;
        }
        .choice-btn:hover { background: #3d3d3d; }
        .choice-btn.active { border-color: var(--highlight); background: rgba(0, 206, 201, 0.1); color: var(--highlight); font-weight: bold; }

        .btn-lang.active[data-lang="cn"] { background: rgba(232, 67, 147, 0.2); border-color: var(--mandarin); color: var(--mandarin); }
        .btn-lang.active[data-lang="jp"] { background: rgba(108, 92, 231, 0.2); border-color: var(--japan); color: var(--japan); }
        .btn-lang.active[data-lang="en"] { background: rgba(9, 132, 227, 0.2); border-color: var(--english); color: var(--english); }
        .btn-sub { font-size: 10px; opacity: 0.6; margin-top: 4px; font-weight: normal; }

        /* ğŸ”¥ å¼µåŠ›é–‹é—œ */
        .tension-switch-container {
            display: flex;
            align-items: center;
            background: #2d2d2d;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #444;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tension-switch-container:hover { background: #333; }
        .tension-switch-container.active { 
            background: rgba(255, 118, 117, 0.15); 
            border-color: var(--tension); 
        }
        .tension-label { flex: 1; font-weight: bold; font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 8px; }
        .tension-switch-container.active .tension-label { color: var(--tension); }
        .toggle-knob {
            width: 36px; height: 20px; background: #555; border-radius: 20px; position: relative; transition: all 0.3s;
        }
        .toggle-knob::after {
            content: ''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: all 0.3s;
        }
        .tension-switch-container.active .toggle-knob { background: var(--tension); }
        .tension-switch-container.active .toggle-knob::after { transform: translateX(16px); }

        /* çµæ§‹ç©æœ¨ */
        .structure-grid { display: flex; gap: 8px; flex-wrap: wrap; }
        .struct-block {
            background: var(--block-bg); border: 1px solid var(--border); padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; user-select: none; transition: all 0.2s;
        }
        .struct-block:hover { background: #3d3d3d; }
        .struct-block.checked { background: rgba(0, 206, 201, 0.15); border-color: var(--highlight); color: var(--highlight); }
        .checkbox-fake { width: 12px; height: 12px; border: 1px solid #777; border-radius: 3px; display: inline-block; position: relative; }
        .struct-block.checked .checkbox-fake { background: var(--highlight); border-color: var(--highlight); }

        .theme-input { width: 100%; background: #000; border: 1px solid var(--lyric); color: #fff; padding: 12px; border-radius: 6px; font-size: 14px; box-sizing: border-box; outline: none; }

        /* è¼¸å‡ºé¢æ¿ */
        .output-panel {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #111; border-top: 3px solid var(--highlight); padding: 15px; box-shadow: 0 -10px 40px rgba(0,0,0,0.9); z-index: 100; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px;
        }
        .output-group { flex: 1; display: flex; flex-direction: column; }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .output-label { font-size: 11px; color: #777; font-weight: bold; text-transform: uppercase; }
        
        .btn-mini-copy {
            background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; padding: 3px 10px; font-size: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
        }
        .btn-mini-copy:hover { background: #555; }
        
        textarea {
            width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px; font-family: monospace; resize: none; box-sizing: border-box; font-size: 11px;
        }
        
        #style-box { height: 45px; color: var(--highlight); }
        #lyrics-box { height: 70px; color: #a29bfe; border-color: #a29bfe; }
        #params-box { height: 35px; color: var(--param); border-color: var(--param); }

        .action-row { display: flex; gap: 10px; margin-top: 5px; border-top: 1px solid #333; padding-top: 10px; }
        .action-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-prompt { background: var(--lyric); color: #000; flex: 2; }
        .btn-reset { background: #222; color: #777; flex: 0.5; border: 1px solid #444; }
        .btn-reset:hover { background: #333; color: #fff; }

    </style>
</head>
<body>

    <h2>æ™‚å…‰æ©Ÿ <span style="font-size:0.5em; opacity:0.5;">V30.0</span></h2>

    <div class="section-box">
        <div class="section-title"><span>1. èªè¨€ (Language)</span></div>
        <div class="grid-container" style="grid-template-columns: repeat(3, 1fr);">
            <button class="choice-btn btn-lang" data-lang="cn" onclick="selectLang('cn', this)"><span>ğŸ‡¨ğŸ‡³ è¯èª/ç²µèª</span></button>
            <button class="choice-btn btn-lang" data-lang="jp" onclick="selectLang('jp', this)"><span>ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span></button>
            <button class="choice-btn btn-lang" data-lang="en" onclick="selectLang('en', this)"><span>ğŸ‡ºğŸ‡¸ English</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-era">
        <div class="section-title"><span>2. å¹´ä»£ (Time Travel)</span> <span id="label-era" style="color:var(--highlight)"></span></div>
        <div class="grid-container" style="grid-template-columns: repeat(4, 1fr);">
            <button class="choice-btn" onclick="selectEra('70s', this)"><span>70s</span><span class="btn-sub">Vintage</span></button>
            <button class="choice-btn" onclick="selectEra('80s', this)"><span>80s</span><span class="btn-sub">Retro</span></button>
            <button class="choice-btn" onclick="selectEra('90s', this)"><span>90s</span><span class="btn-sub">Classic</span></button>
            <button class="choice-btn" onclick="selectEra('00s', this)"><span>00s</span><span class="btn-sub">Millennium</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-vocal" style="border-left: 3px solid var(--vocal);">
        <div class="section-title"><span>3. éˆé­‚é¸è§’ (Vocal)</span></div>
        <div class="grid-mini">
            <button class="choice-btn" onclick="selectGender('male', this)"><span>ğŸ™‹ğŸ»â€â™‚ï¸ ç”·è² (Male)</span><span class="btn-sub" id="desc-male">--</span></button>
            <button class="choice-btn" onclick="selectGender('female', this)"><span>ğŸ™‹ğŸ»â€â™€ï¸ å¥³è² (Female)</span><span class="btn-sub" id="desc-female">--</span></button>
        </div>
    </div>

    <div class="section-box disabled" id="section-struct">
        <div class="section-title"><span>4. å°æ¼”çµæ§‹ (Structure)</span></div>
        
        <div class="tension-switch-container" onclick="toggleTension()">
            <div class="tension-label">
                <span>ğŸ”¥ é–‹å•Ÿé«˜å¼µåŠ›æ¨¡å¼ (High Tension Mode)</span>
                <span style="font-size:10px; opacity:0.7; font-weight:normal;">è‡ªå‹•æ³¨å…¥ã€Œç¨å¥ / éŸ³ç‰† / ç…è»Šã€ç­‰å¤§å¸«æŒ‡ä»¤</span>
            </div>
            <div class="toggle-knob"></div>
        </div>

        <div class="structure-grid" id="struct-container"></div>
    </div>

    <div class="section-box disabled" id="section-theme" style="border-left: 3px solid var(--lyric);">
        <div class="section-title"><span style="color:var(--lyric)">5. æ­Œè©ä¸»é¡Œ (çµ¦ AI å¡«è©ç”¨)</span></div>
        <input type="text" id="theme-input" class="theme-input" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ä¸‹é›¨çš„å¤œæ™šï¼Œæ€å¿µå‰ä»»...">
    </div>

    <div class="output-panel">
        
        <div class="output-group">
            <div class="output-header">
                <span class="output-label">Style (é¢¨æ ¼) <span id="logic-log" style="font-weight:normal; text-transform:none; margin-left:5px; color:#555;"></span></span>
                <button class="btn-mini-copy" onclick="copySingle('style-box', this)">ğŸ“‹ è¤‡è£½ Style</button>
            </div>
            <textarea id="style-box" readonly placeholder="Style Tags..."></textarea>
        </div>

        <div class="output-group">
            <div class="output-header">
                <span class="output-label" style="color: var(--param)">Params (åƒæ•¸)</span>
                <button class="btn-mini-copy" onclick="copySingle('params-box', this)">ğŸ“‹ è¤‡è£½ Params</button>
            </div>
            <textarea id="params-box" readonly placeholder="Weirdness / Exclude..."></textarea>
        </div>

        <div class="output-group">
            <div class="output-header">
                <span class="output-label">Lyrics (çµæ§‹/æ­Œè©)</span>
                <button class="btn-mini-copy" onclick="copySingle('lyrics-box', this)">ğŸ“‹ è¤‡è£½ Lyrics</button>
            </div>
            <textarea id="lyrics-box" readonly placeholder="Structure..."></textarea>
        </div>

        <div class="action-row">
            <button class="action-btn btn-prompt" onclick="copyLyricsPrompt()">ğŸ¤– è¤‡è£½å¡«è© Prompt (çµ¦ ChatGPT)</button>
            <button class="action-btn btn-reset" onclick="resetAll()">ğŸ”„ é‡ç½®</button>
        </div>
    </div>

    <script>
        // --- V30.0 é›™å±¤è³‡æ–™åº« (Dual-Layer Database) ---
        // normal: å®‰å…¨ç‰Œ | tension: å¤§å¸«ç´šæ¸¬è©¦æŒ‡ä»¤ (Solitary Cello, Wall of Sound, etc.)
        const timeMachineData = {
            "cn": {
                "70s": {
                    baseTags: "70s Mandopop, Vintage Recording, Analog Warmth, Mono, Low Fidelity, Tape Hiss, Slow Tempo",
                    params: "Exclude: Modern, Digital | Weirdness: 20% | Influence: 85%",
                    vocals: { male: { tag: "Warm, Conversational, Folk Style", desc: "è¨±å† å‚‘å¼" }, female: { tag: "Sweet, Airy, Whispery, Crystal Clear", desc: "é„§éº—å›å¼" } },
                    structDefaults: ["intro", "verse", "chorus", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Melodic Flute Solo]", verse: "[Verse 1: Sweet Airy Vocals]", chorus: "[Chorus: Gentle Harmony]", bridge: "[Bridge: Acoustic Guitar]", outro: "[Outro: Fade out]" },
                        tension: { intro: "[Intro: Solitary Flute Solo, Minimalist, Silence]", verse: "[Verse 1: Very Close Proximity, Whisper]", chorus: "[Chorus: Emotional Swell, Strings Section]", bridge: "[Bridge: Harmonica Solo, Nostalgic]", outro: "[Outro: Spoken Word, Fade into Silence]" }
                    }
                },
                "80s": {
                    baseTags: "80s Cantopop, Synth-Pop, Gated Reverb, Analog Synth, Dramatic",
                    params: "Exclude: Acoustic | Weirdness: 30% | Influence: 70%",
                    vocals: { male: { tag: "Romantic, Baritone, Heavy Reverb", desc: "å¼µåœ‹æ¦®å¼" }, female: { tag: "Contralto, Soulful, Powerful", desc: "æ¢…è‰·èŠ³å¼" } },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Synth Hook]", verse: "[Verse 1: Reverb Vocals]", chorus: "[Chorus: Catchy Melody]", bridge: "[Bridge: Guitar Solo]", outro: "[Outro: Fade out]" },
                        tension: { intro: "[Intro: Massive Gated Reverb Drums, Synth Stab]", verse: "[Verse 1: Deep Emotional, Atmospheric]", chorus: "[Chorus: Power Anthem, Stadium Sound, High Energy]", bridge: "[Bridge: Electric Guitar Shredding, Key Change]", outro: "[Outro: Repeat Chorus, Grand Finale]" }
                    }
                },
                "90s": {
                    baseTags: "90s Mandopop, Power Ballad, Orchestral, Piano, Wide Stereo",
                    params: "Exclude: Lofi | Weirdness: 40%",
                    vocals: { male: { tag: "Deep, Heavy Vibrato, Belting", desc: "å¼µå­¸å‹å¼" }, female: { tag: "Ethereal, Falsetto, Dream Pop", desc: "ç‹è²å¼" } },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Grand Piano]", verse: "[Verse 1: Emotional]", chorus: "[Chorus: Powerful]", bridge: "[Bridge: Slow down]", outro: "[Outro: Silence]" },
                        tension: { intro: "[Intro: Solitary Cello, Minimalist, Dark]", verse: "[Verse 1: Soft Vocals, Building Up]", chorus: "[Chorus: WALL OF SOUND, Full Orchestra, Massive Texture, Emotional Explosion]", bridge: "[Bridge: Decrescendo, Slowing Down, Strip back instruments]", outro: "[Outro: Sudden Silence, Piano decay]" }
                    }
                },
                "00s": {
                    baseTags: "00s Mandopop, R&B, Pentatonic, Hip Hop Beat",
                    params: "Exclude: EDM | Weirdness: 40%",
                    vocals: { male: { tag: "Mumble, R&B Flow, Slurred", desc: "å‘¨æ°å€«å¼" }, female: { tag: "Youthful, Bright, Pop", desc: "æ¢éœèŒ¹å¼" } },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Piano]", verse: "[Verse 1: R&B]", chorus: "[Chorus: Chinese Style]", bridge: "[Bridge: Rap]", outro: "[Outro: Piano]" },
                        tension: { intro: "[Intro: Classical Piano Solo, Fast Arpeggio]", verse: "[Verse 1: Mumble Rap, Laid back, Groovy]", chorus: "[Chorus: Epic R&B, Chinese Instruments, Heavy Bass]", bridge: "[Bridge: Fast Rap Flow, Double Time]", outro: "[Outro: Sound FX, Vinyl Stop]" }
                    }
                }
            },
            "jp": {
                "70s": {
                    baseTags: "70s Enka, Kayokyoku, Showa Era, Orchestral, Melodramatic",
                    params: "Exclude: Modern | Weirdness: 30%",
                    vocals: { male: {tag: "Deep, Kobushi", desc: "æ¼”æ­Œ"}, female: {tag: "Melancholic", desc: "æ˜­å’Œ"} },
                    structDefaults: ["intro", "verse", "chorus", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Enka Intro]", verse: "[Verse 1: Sad]", chorus: "[Chorus: Powerful]", bridge: "[Bridge: Sax]", outro: "[Outro: End]" },
                        tension: { intro: "[Intro: Spoken Word with Deep Emotion, Rain Sound]", verse: "[Verse 1: Trembling Voice, Melancholic]", chorus: "[Chorus: Dramatic, Kobushi, Guttural]", bridge: "[Bridge: Tearful Saxophone Solo]", outro: "[Outro: Grand Orchestral Finale]" }
                    }
                },
                "80s": {
                    baseTags: "City Pop, Funk, Slap Bass, Neon, Urban",
                    params: "Exclude: Sad | Weirdness: 60%",
                    vocals: { male: {tag: "Funky", desc: "é”éƒå¼"}, female: {tag: "Bright, Idol", desc: "è–å­å¼"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Funky Guitar]", verse: "[Verse 1: Smooth]", chorus: "[Chorus: Catchy]", bridge: "[Bridge: Synth]", outro: "[Outro: Fade]" },
                        tension: { intro: "[Intro: Slap Bass Solo, Neon Lights Vibe]", verse: "[Verse 1: Groovy, Syncopated Rhythm]", chorus: "[Chorus: High Pitch, Sparkling, Upbeat Explosion]", bridge: "[Bridge: Synthesizer Solo, Futuristic]", outro: "[Outro: Vocal Ad-libs, Fade out]" }
                    }
                },
                "90s": {
                    baseTags: "J-Rock, Visual Kei, Distortion, Fast Tempo",
                    params: "Exclude: Pop | Weirdness: 50%",
                    vocals: { male: {tag: "Nasal, High Pitch", desc: "è¦–è¦ºç³»"}, female: {tag: "Power, Eurobeat", desc: "å®‰å®¤å¼"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Guitar]", verse: "[Verse 1: Low]", chorus: "[Chorus: Loud]", bridge: "[Bridge: Solo]", outro: "[Outro: Noise]" },
                        tension: { intro: "[Intro: Fast Electric Guitar Riff, Aggressive]", verse: "[Verse 1: Whispering building to Screaming]", chorus: "[Chorus: High Pitch Screaming, Melodic, Double Bass Drum]", bridge: "[Bridge: Twin Guitar Solo, Neoclassical]", outro: "[Outro: Feedback Noise, Glass Breaking]" }
                    }
                },
                "00s": {
                    baseTags: "00s J-Pop, R&B, Automatic, Polished",
                    params: "Exclude: Enka | Weirdness: 40%",
                    vocals: { male: {tag: "Smooth, R&B", desc: "å¹³äº•å …å¼"}, female: {tag: "Husky, Vibrato", desc: "å®‡å¤šç”°å¼"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Beat]", verse: "[Verse 1: R&B]", chorus: "[Chorus: Pop]", bridge: "[Bridge: Rap]", outro: "[Outro: Fade]" },
                        tension: { intro: "[Intro: Electronic Beat, Glitch]", verse: "[Verse 1: Breathable Vocals, R&B Flow]", chorus: "[Chorus: Emotional Melody, Complex Harmony]", bridge: "[Bridge: English Rap, Breakdown]", outro: "[Outro: Sudden Stop]" }
                    }
                }
            },
            "en": {
                "70s": {
                    baseTags: "70s Soft Rock, Folk, Acoustic, Warm",
                    params: "Exclude: Digital",
                    vocals: { male: {tag: "Soft, Folk", desc: "Folk"}, female: {tag: "Warm, Velvet", desc: "Karen"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Guitar]", verse: "[Verse 1: Story]", chorus: "[Chorus: Harmony]", bridge: "[Bridge: Piano]", outro: "[Outro: Fade]" },
                        tension: { intro: "[Intro: Fingerpicking Acoustic Guitar, Intimate]", verse: "[Verse 1: Storytelling, Warm, Dry]", chorus: "[Chorus: Lush Harmonies, Multi-tracked]", bridge: "[Bridge: Gentle Piano Interlude]", outro: "[Outro: Long Fade Out, Nostalgic]" }
                    }
                },
                "80s": {
                    baseTags: "80s Pop, Synthwave, Analog Synth",
                    params: "Exclude: Acoustic",
                    vocals: { male: {tag: "Falsetto", desc: "MJ Style"}, female: {tag: "Power Diva", desc: "Madonna"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Synth]", verse: "[Verse 1: Beat]", chorus: "[Chorus: Dance]", bridge: "[Bridge: Key Change]", outro: "[Outro: Vocal]" },
                        tension: { intro: "[Intro: Iconic Synth Riff, Drum Machine Fill]", verse: "[Verse 1: Percussive Vocals, Hiccups]", chorus: "[Chorus: High Energy, Danceable, Explosive]", bridge: "[Bridge: Dramatic Key Change]", outro: "[Outro: Vocal Ad-libs, High Note]" }
                    }
                },
                "90s": {
                    baseTags: "Britpop, Grunge, Distortion",
                    params: "Exclude: Pop",
                    vocals: { male: {tag: "Raspy, Nasal", desc: "Oasis"}, female: {tag: "Powerhouse", desc: "Mariah"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Distortion]", verse: "[Verse 1: Low]", chorus: "[Chorus: Loud]", bridge: "[Bridge: Noise]", outro: "[Outro: Feedback]" },
                        tension: { intro: "[Intro: Dirty Distorted Guitar Riff, Feedback]", verse: "[Verse 1: Mumbled Vocals, Slurred, Laid back]", chorus: "[Chorus: Anthem-like, Massive Wall of Sound, Raspy]", bridge: "[Bridge: Noise Build-up, Chaos]", outro: "[Outro: Amplifier Hum, Feedback]" }
                    }
                },
                "00s": {
                    baseTags: "Pop Punk, High Energy",
                    params: "Exclude: Slow",
                    vocals: { male: {tag: "Nasal, Punk", desc: "Punk"}, female: {tag: "Sassy", desc: "Avril"} },
                    structDefaults: ["intro", "verse", "chorus", "bridge", "outro"],
                    blocks: {
                        normal: { intro: "[Intro: Drums]", verse: "[Verse 1: Palm Mute]", chorus: "[Chorus: Catchy]", bridge: "[Bridge: Half-time]", outro: "[Outro: Chord]" },
                        tension: { intro: "[Intro: Fast Drum Fill, Power Chords]", verse: "[Verse 1: Palm Mute Guitar, Bass only]", chorus: "[Chorus: High Energy, Catchy, Gang Vocals]", bridge: "[Bridge: Half-time breakdown, Slowing down]", outro: "[Outro: Final Ringing Chord]" }
                    }
                }
            }
        };

        let currentLang = null, currentEra = null, currentGender = null;
        let isTensionMode = false; // ğŸ”¥ å¼µåŠ›æ¨¡å¼ç‹€æ…‹

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function toggleTension() {
            const btn = document.querySelector('.tension-switch-container');
            isTensionMode = !isTensionMode;
            if(isTensionMode) btn.classList.add('active');
            else btn.classList.remove('active');
            
            // é‡æ–°è¼‰å…¥çµæ§‹ï¼ˆå¦‚æœå·²é¸å¹´ä»£ï¼‰
            if(currentEra) {
                // ä¿æŒç›®å‰çš„å‹¾é¸ç‹€æ…‹
                const checkedBlocks = Array.from(document.querySelectorAll('.struct-block.checked')).map(b => b.dataset.type);
                loadStructure(checkedBlocks);
            }
        }

        function selectLang(lang, btn) {
            currentLang = lang; currentEra = null; currentGender = null;
            document.querySelectorAll('.btn-lang').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('section-era').classList.remove('disabled');
            document.getElementById('label-era').innerText = "è«‹é¸æ“‡å¹´ä»£...";
            document.querySelectorAll('#section-era .choice-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('section-vocal').classList.add('disabled');
            document.getElementById('section-struct').classList.add('disabled');
            document.getElementById('section-theme').classList.add('disabled');
            resetOutput();
        }

        function selectEra(era, btn) {
            currentEra = era; currentGender = null;
            document.querySelectorAll('#section-era .choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const data = timeMachineData[currentLang][era];
            document.getElementById('label-era').innerText = era;
            document.getElementById('section-vocal').classList.remove('disabled');
            document.querySelectorAll('#section-vocal .choice-btn').forEach(b => b.classList.remove('active'));
            if(data.vocals) {
                document.getElementById('desc-male').innerText = data.vocals.male.desc;
                document.getElementById('desc-female').innerText = data.vocals.female.desc;
            }
            loadStructure(data.structDefaults); // è¼‰å…¥é è¨­å‹¾é¸
            renderOutput();
        }

        function selectGender(gender, btn) {
            currentGender = gender;
            document.querySelectorAll('#section-vocal .choice-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderOutput();
        }

        function loadStructure(checkedTypes) {
            const container = document.getElementById('struct-container');
            container.innerHTML = '';
            document.getElementById('section-struct').classList.remove('disabled');
            document.getElementById('section-theme').classList.remove('disabled');

            const allTypes = ['intro', 'verse', 'chorus', 'bridge', 'outro'];
            const data = timeMachineData[currentLang][currentEra];
            const contentSource = isTensionMode ? data.blocks.tension : data.blocks.normal;

            allTypes.forEach(type => {
                if(!contentSource[type]) return;

                const div = document.createElement('div');
                div.className = 'struct-block';
                div.dataset.type = type;
                div.innerHTML = `<span class="checkbox-fake"></span> ${type.charAt(0).toUpperCase() + type.slice(1)}`;
                
                // æ¢å¾©å‹¾é¸ç‹€æ…‹ æˆ– ä½¿ç”¨é è¨­å€¼
                if(checkedTypes.includes(type)) div.classList.add('checked');

                div.onclick = () => { div.classList.toggle('checked'); renderLyrics(); };
                container.appendChild(div);
            });
            renderLyrics();
        }

        function renderLyrics() {
            if(!currentEra) return;
            const data = timeMachineData[currentLang][currentEra];
            const contentSource = isTensionMode ? data.blocks.tension : data.blocks.normal;
            
            let text = "";
            document.querySelectorAll('.struct-block.checked').forEach(block => {
                const type = block.dataset.type;
                text += contentSource[type] + "\n\n";
            });
            document.getElementById('lyrics-box').value = text.trim();
        }

        function renderOutput() {
            if (!currentLang || !currentEra) return;
            const data = timeMachineData[currentLang][currentEra];
            document.getElementById('params-box').value = data.params;
            let tags = [data.baseTags];
            let logicMsg = "";
            if (currentGender && data.vocals) {
                tags.push(data.vocals[currentGender].tag);
                tags.push(currentGender === 'male' ? "Male Vocals" : "Female Vocals");
                logicMsg = `âœ¨ ${data.vocals[currentGender].desc}`;
            }
            document.getElementById('style-box').value = tags.join(", ");
            document.getElementById('logic-log').innerText = logicMsg;
        }

        // --- V29 ç¨ç«‹è¤‡è£½ ---
        function copySingle(elementId, btn) {
            const el = document.getElementById(elementId);
            if (!el || !el.value) return;
            navigator.clipboard.writeText(el.value).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "âœ… å·²è¤‡è£½";
                btn.style.background = "var(--highlight)";
                btn.style.color = "#000";
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = "#333";
                    btn.style.color = "#fff";
                }, 1500);
            });
        }

        function copyLyricsPrompt() {
            const theme = document.getElementById('theme-input').value || "é—œæ–¼æ„›æƒ…èˆ‡å›æ†¶";
            const structure = document.getElementById('lyrics-box').value;
            const era = currentEra;
            let langPrompt = currentLang === 'cn' ? "Traditional Chinese" : currentLang === 'jp' ? "Japanese (include Romaji)" : "English";

            const prompt = `Role: Professional Songwriter\nTask: Write lyrics.\nContext:\n- Language: ${langPrompt}\n- Era/Style: ${era}\n- Theme: "${theme}"\n\nStructure to Fill (Strictly follow tags):\n${structure}`;
            
            navigator.clipboard.writeText(prompt);
            const btn = document.querySelector('.btn-prompt');
            btn.innerText = "âœ… Prompt å·²è¤‡è£½ï¼";
            setTimeout(() => btn.innerText = "ğŸ¤– è¤‡è£½å¡«è© Prompt (çµ¦ ChatGPT)", 2000);
        }

        function resetAll() {
            currentLang = null; currentEra = null; currentGender = null; isTensionMode = false;
            document.querySelector('.tension-switch-container').classList.remove('active');
            document.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
            document.getElementById('section-era').classList.add('disabled');
            document.getElementById('section-vocal').classList.add('disabled');
            document.getElementById('section-struct').classList.add('disabled');
            document.getElementById('section-theme').classList.add('disabled');
            document.getElementById('style-box').value = "";
            document.getElementById('params-box').value = "";
            document.getElementById('lyrics-box').value = "";
            document.getElementById('struct-container').innerHTML = "";
            document.getElementById('label-era').innerText = "";
            document.getElementById('desc-male').innerText = "--";
            document.getElementById('desc-female').innerText = "--";
            document.getElementById('theme-input').value = "";
            document.getElementById('logic-log').innerText = "";
        }
    </script>
</body>
</html>